generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MaterialType {
  PRESENTATION
  VIDEO
  LECTURE_MATERIAL
}

model categories {
  id          String    @id @db.VarChar(16)
  name        String    @unique @db.VarChar(200)
  description String?
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  courses     courses[]
}

model certificates {
  id            String       @id @db.VarChar(16)
  user_id       String       @db.VarChar(16)
  course_id     String       @db.VarChar(16)
  enrollment_id String?      @db.VarChar(16)
  issued_at     DateTime     @default(now()) @db.Timestamptz(6)
  cert_data     Json?
  created_at    DateTime     @default(now()) @db.Timestamptz(6)
  courses       courses      @relation(fields: [course_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  enrollments   enrollments? @relation(fields: [enrollment_id], references: [id], onUpdate: NoAction)
  users         users        @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([course_id], map: "idx_certificates_course")
  @@index([user_id], map: "idx_certificates_user")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model courses {
  id                 String               @id @db.VarChar(16)
  title              String               @db.VarChar(300)
  short_description  String?              @db.VarChar(1000)
  full_description   String?
  review_count       Int                  @default(0)
  avg_rating         Decimal?             @default(0) @db.Decimal(3, 2)
  difficulty_level   String?              @db.VarChar(50)
  category_id        String?              @db.VarChar(16)
  teacher_id         String?              @db.VarChar(16)
  created_at         DateTime             @default(now()) @db.Timestamptz(6)
  updated_at         DateTime             @default(now()) @db.Timestamptz(6)
  certificates       certificates[]
  categories         categories?          @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  teacher            users?               @relation("TeacherCourses", fields: [teacher_id], references: [id], onUpdate: NoAction)
  enrollments        enrollments[]
  lesson_completions lesson_completions[]
  modules            modules[]
  payments           payments[]
  reviews            reviews[]
  tests              tests[]

  @@index([category_id], map: "idx_courses_category")
  @@index([teacher_id], map: "idx_courses_teacher")
  @@index([difficulty_level], map: "idx_courses_difficulty")
}

model enrollments {
  id             String         @id @db.VarChar(16)
  user_id        String         @db.VarChar(16)
  course_id      String         @db.VarChar(16)
  last_lesson_id String?        @db.VarChar(16)
  enrolled_at    DateTime       @default(now()) @db.Timestamptz(6)
  status         String         @default("active") @db.VarChar(50)
  progress       Decimal        @default(0) @db.Decimal(5, 2)
  certificates   certificates[]
  courses        courses        @relation(fields: [course_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  last_lesson    lessons?       @relation(fields: [last_lesson_id], references: [id], onUpdate: NoAction)
  users          users          @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, course_id])
  @@index([course_id], map: "idx_enrollments_course")
  @@index([user_id], map: "idx_enrollments_user")
}

model lessons {
  id                 String               @id @db.VarChar(16)
  module_id          String               @db.VarChar(16)
  title              String               @db.VarChar(300)
  content            String?
  material_url       String?
  material_type      MaterialType
  position           Int                  @default(0)
  created_at         DateTime             @default(now()) @db.Timestamptz(6)
  updated_at         DateTime             @default(now()) @db.Timestamptz(6)
  enrollments        enrollments[]
  lesson_completions lesson_completions[]
  tests              tests[]
  practices          practices[]
  modules            modules              @relation(fields: [module_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([module_id], map: "idx_lessons_module_id")
  @@index([module_id, position], map: "idx_lessons_module_position")
}

model practices {
  id              String   @id @default(uuid()) @db.VarChar(36)
  lesson_id       String   @db.VarChar(16)
  title           String   @db.VarChar(300)
  description     String?  // Описание задачи (что нужно сделать)
  language        String   @default("javascript") @db.VarChar(50)
  initial_code    String?  @db.Text // Код, который появляется в редакторе
  expected_output String?  @db.Text // Ожидаемый вывод (для простых проверок)
  test_cases      Json?    // JSON с тест-кейсами [{input: "1,2", output: "3"}]
  solution_code   String?  @db.Text // Решение учителя
  
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)

  lessons         lessons  @relation(fields: [lesson_id], references: [id], onDelete: Cascade)
  
  @@index([lesson_id], map: "idx_practices_lesson")
}

model modules {
  id          String    @id @db.VarChar(16)
  course_id   String    @db.VarChar(16)
  title       String    @db.VarChar(300)
  description String?
  position    Int       @default(0)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  updated_at  DateTime  @default(now()) @db.Timestamptz(6)
  lessons     lessons[]
  tests       tests[]
  courses     courses   @relation(fields: [course_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([course_id], map: "idx_modules_course_id")
}

model payments {
  id                  String   @id @db.VarChar(16)
  user_id             String?  @db.VarChar(16)
  course_id           String?  @db.VarChar(16)
  amount_cents        BigInt
  currency            String   @default("USD") @db.VarChar(10)
  payment_date        DateTime @default(now()) @db.Timestamptz(6)
  provider            String?  @db.VarChar(100)
  provider_payment_id String?
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  courses             courses? @relation(fields: [course_id], references: [id], onUpdate: NoAction)
  users               users?   @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([user_id, payment_date], map: "idx_payments_user_date")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model reviews {
  id          String   @id @db.VarChar(16)
  user_id     String   @db.VarChar(16)
  course_id   String   @db.VarChar(16)
  rating      Int      @db.SmallInt
  text        String?
  review_date DateTime @default(now()) @db.Timestamptz(6)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  courses     courses  @relation(fields: [course_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([course_id], map: "idx_reviews_course")
  @@index([user_id], map: "idx_reviews_user")
}

model users {
  id                 String               @id @db.VarChar(16)
  first_name         String               @db.VarChar(100)
  sur_name           String               @db.VarChar(100)
  email              String               @unique @db.VarChar(255)
  password_hash      String
  role               String               @default("student") @db.VarChar(50)
  created_at         DateTime             @default(now()) @db.Timestamptz(6)
  updated_at         DateTime             @default(now()) @db.Timestamptz(6)
  certificates       certificates[]
  enrollments        enrollments[]
  lesson_completions lesson_completions[]
  payments           payments[]
  reviews            reviews[]
  user_test_results  user_test_results[]
  created_courses    courses[]            @relation("TeacherCourses")
}

model lesson_completions {
  id           String   @id @db.VarChar(16)
  user_id      String   @db.VarChar(16)
  lesson_id    String   @db.VarChar(16)
  course_id    String   @db.VarChar(16)
  completed_at DateTime @default(now()) @db.Timestamptz(6)
  courses      courses  @relation(fields: [course_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lessons      lessons  @relation(fields: [lesson_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users        users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, lesson_id])
  @@index([user_id], map: "idx_lesson_completions_user")
  @@index([course_id], map: "idx_lesson_completions_course")
}

model tests {
  id          String      @id @default(uuid()) @db.VarChar(36)
  title       String      @db.VarChar(300)
  description String?
  lesson_id   String?     @db.VarChar(16)
  module_id   String?     @db.VarChar(16)
  course_id   String?     @db.VarChar(16)
  questions_to_show Int?  @default(0)
  passing_score     Int?  @default(0)
  created_at  DateTime    @default(now()) @db.Timestamptz(6)
  updated_at  DateTime    @default(now()) @db.Timestamptz(6)
  
  lessons     lessons?    @relation(fields: [lesson_id], references: [id], onDelete: Cascade)
  modules     modules?    @relation(fields: [module_id], references: [id], onDelete: Cascade)
  courses     courses?    @relation(fields: [course_id], references: [id], onDelete: Cascade)
  questions   questions[]
  user_test_results user_test_results[]

  @@index([lesson_id], map: "idx_tests_lesson")
  @@index([module_id], map: "idx_tests_module")
  @@index([course_id], map: "idx_tests_course")
}

model questions {
  id          String    @id @default(uuid()) @db.VarChar(36)
  test_id     String    @db.VarChar(36)
  text        String
  type        String    @default("single_choice") @db.VarChar(50) // single_choice, multiple_choice
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  
  tests       tests     @relation(fields: [test_id], references: [id], onDelete: Cascade)
  answers     answers[]

  @@index([test_id], map: "idx_questions_test")
}

model answers {
  id          String    @id @default(uuid()) @db.VarChar(36)
  question_id String    @db.VarChar(36)
  text        String
  is_correct  Boolean   @default(false)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)

  questions   questions @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@index([question_id], map: "idx_answers_question")
}

model user_test_results {
  id           String   @id @default(uuid()) @db.VarChar(36)
  user_id      String   @db.VarChar(16)
  test_id      String   @db.VarChar(36)
  score        Int      @default(0)
  passed       Boolean  @default(false)
  completed_at DateTime @default(now()) @db.Timestamptz(6)
  
  users        users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  tests        tests    @relation(fields: [test_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "idx_user_test_results_user")
  @@index([test_id], map: "idx_user_test_results_test")
}
